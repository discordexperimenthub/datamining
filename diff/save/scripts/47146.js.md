```diff
            },
            play: function () {
              return d;
            },
            getMetadata: function () {
- 
+             return s;
            },
          }),
          i("70102");
        var n = i("872717"),
          l = i("913144"),
```

```diff
                activity: e,
                userId: t,
              })
            );
        }
- 
- 
+         s(e, t)
+       function s(e, t) {
          let i = e.metadata;
          if (null != i) return Promise.resolve(i);
          let r = a.default.getActivityMetadata(t);
          return null != r
            ? Promise.resolve(r)
```

```diff
            let {
                section: n,
                page: l,
                object: u,
                objectType: r,
-         s = i("49111");
- 
- 
+         s = i("117362"),
+               children: s,
              } = this.props,
```

```diff
              c = this.getContext(
- 
-               s,
- 
+             o = this.mergeLocation(e.location, this.getLocation(l, n, u, r)),
+               o,
                null !== (t = this._loadDate) && void 0 !== t ? t : e.loadDate,
                null !== (i = this._loadId) && void 0 !== i ? i : e.loadId
              );
            return (0, a.jsx)(d.AnalyticsContext.Provider, {
              value: c,
```

```diff
          }
          constructor(e) {
            super(e),
              (this._loadId = null),
              (this._loadDate = this.props.root ? Date.now() : null),
- 
- 
+             children: s,
+             (this.getLocation = (0, s.cachedFunction)((e, t, i, n) => {
                let l = {};
                return (
                  null != e && (l.page = e),
                  null != t && (l.section = t),
                  null != i && (l.object = i),
```

```diff
                ...e,
                ...t,
              }))),
- 
- 
+             (this.mergeLocation = (0, s.cachedFunction)((e, t) => ({
+             (this.getContext = (0, s.cachedFunction)((e, t, i) => ({
                location: e,
                loadDate: t,
                loadId: i,
              }))),
              null != e.loadId
```

```diff
          i.d(t, {
            default: function () {
              return n;
            },
          }),
-         (n.Sections = s.AnalyticsSections),
-         (n.Objects = s.AnalyticsObjects),
-         (n.ObjectTypes = s.AnalyticsObjectTypes),
- 
+       }).Pages = o.AnalyticsPages),
+         i("424973"),
          i("222007");
        var n,
```

```diff
          var t;
          let i =
              (null == e ? void 0 : e.activity) != null
-         l = i("913144"),
-         a = i("255397"),
-         u = i("316272"),
-         r = i("651057"),
-         d = i("299285"),
-         o = i("191145"),
-         s = i("601222"),
-         c = i("233069"),
-         f = i("271938"),
-         _ = i("42203"),
-         E = i("945956"),
-         I = i("18494"),
-         A = i("697218"),
-         T = i("599110"),
-         C = i("773336"),
-         v = i("289732"),
-         S = i("550766"),
-         N = i("191225"),
-         h = i("602718"),
-         D = i("885829"),
-         p = i("986214"),
-         y = i("126939"),
-         O = i("837707"),
-         g = i("334368"),
-         L = i("15264"),
-         m = i("673044"),
-         P = i("803353"),
-         M = i("420444"),
-         b = i("954016"),
-         U = i("49111"),
-         V = i("782340");
-       let R = {},
-         F = {};
-       function Y(e) {
- 
- 
+         l = i("627445"),
+         a = i.n(l),
+         u = i("748820"),
+         r = i("913144"),
+         d = i("255397"),
+         s = i("316272"),
+         o = i("651057"),
+         c = i("299285"),
+         f = i("191145"),
+         _ = i("601222"),
+         E = i("233069"),
+         I = i("271938"),
+         A = i("42203"),
+         T = i("945956"),
+         C = i("18494"),
+         v = i("697218"),
+         S = i("599110"),
+         N = i("773336"),
+         y = i("289732"),
+         h = i("550766"),
+         p = i("191225"),
+         D = i("602718"),
+         O = i("885829"),
+         g = i("986214"),
+         L = i("126939"),
+         m = i("837707"),
+         P = i("334368"),
+         M = i("15264"),
+         b = i("673044"),
+         U = i("803353"),
+         V = i("420444"),
+         R = i("954016"),
+         F = i("49111"),
+         Y = i("782340");
+       let w = {},
+         G = {};
+       function B(e) {
+               ? !(0, M.default)(null == e ? void 0 : e.activity)
                : void 0,
            n =
              (null == e ? void 0 : e.activity) != null
```

```diff
            l =
              null == e
                ? void 0
                : null === (t = e.activity) || void 0 === t
                  ? void 0
- 
- 
+               ? (0, b.default)(null == e ? void 0 : e.activity)
+                 : t.client_platform_config[(0, P.default)((0, N.getOS)())]
                      .release_phase;
          return { isPremiumActivity: i, isFreePeriod: n, releasePhase: l };
        }
```

```diff
          let { channelId: t, applicationId: i, analyticsLocations: n } = e,
- 
- 
+       async function H(e) {
+           l = A.default.getChannel(t),
            a = null == l ? void 0 : l.getGuildId(),
```

```diff
          if (null == l || null == u) return;
- 
-           d = v.default.getState().shelfOrder,
-           c =
- 
+           u = v.default.getCurrentUser();
+         let r = p.default.getShelfActivities(a),
              0 ===
```

```diff
                .getEmbeddedActivitiesForChannel(t)
                .filter(e => e.applicationId === i).length,
- 
-           E = 1 + d.findIndex(e => e === i),
-           { isPremiumActivity: I, isFreePeriod: C, releasePhase: S } = Y(f),
-           D = await (0, s.default)();
-         F[i] = e => {
-           var t, a;
-           (R[i] = e),
-             T.default.track(U.AnalyticEvents.ACTIVITY_SESSION_JOINED, {
- 
+             p.default
+           o = (0, D.default)({ applicationId: i, activityConfigs: r }),
                channel_id: l.id,
                guild_id: l.getGuildId(),
```

```diff
                activity_session_id: e.activitySessionId,
                application_id: i,
                location_stack: n,
                user_premium_tier: u.premiumType,
-               media_session_id: null == e ? void 0 : e.mediaSessionId,
- 
-               is_free_period: C,
-               raw_thermal_state: D,
-               n_participants: o.default.getUserParticipantCount(l.id),
-               is_activity_start: c,
-               release_phase: S,
- 
+               media_session_id: e.mediaSessionIds[0],
+               is_premium_activity: E,
                activity_premium_tier_requirement:
```

```diff
                    ? void 0
- 
- 
+                 null == o
+                   : null === (t = o.activity) || void 0 === t
                      ? void 0
                      : t.premium_tier_requirement,
                shelf_rank:
```

```diff
                    ? void 0
- 
- 
+                 null == o
+                   : null === (a = o.activity) || void 0 === a
                      ? void 0
                      : a.shelf_rank,
```

```diff
              });
          };
        }
- 
- 
+               shelf_sorted_rank: c > 0 ? c : null,
+       async function k(e) {
          var t, i;
          let { channelId: n, applicationId: l } = e,
```

```diff
          if (null == a || null == u || null == d) return;
-           u = _.default.getChannel(n),
-           r = N.default.getEmbeddedActivityDurationMs(n, l),
-           d = A.default.getCurrentUser(),
-           o = null == u ? void 0 : u.getGuildId();
- 
-           f = (0, h.default)({ applicationId: l, activityConfigs: c }),
-           { isPremiumActivity: E, isFreePeriod: I, releasePhase: C } = Y(f),
-           v = await (0, s.default)();
-         T.default.track(U.AnalyticEvents.ACTIVITY_SESSION_LEFT, {
- 
+           a = w[l],
+         let o = p.default.getShelfActivities(s),
            channel_id: u.id,
            guild_id: u.getGuildId(),
```

```diff
            activity_session_id: a.activitySessionId,
            application_id: l,
            duration_ms: r,
            user_premium_tier: d.premiumType,
-           media_session_id: a.mediaSessionId,
- 
-           is_free_period: I,
-           raw_thermal_state: v,
-           release_phase: C,
- 
+           media_session_id: a.mediaSessionIds[0],
+           is_premium_activity: f,
            activity_premium_tier_requirement:
```

```diff
                ? void 0
- 
- 
+             null == c
+               : null === (t = c.activity) || void 0 === t
                  ? void 0
                  : t.premium_tier_requirement,
            shelf_rank:
```

```diff
                ? void 0
- 
- 
+             null == c
+               : null === (i = c.activity) || void 0 === i
                  ? void 0
                  : i.shelf_rank,
```

```diff
          }),
-           delete F[l],
-           delete R[l];
- 
+           activity_user_session_id: a.activityUserSessionId,
+           channel_type: u.type,
+           media_session_ids: a.mediaSessionIds,
+           S.default.track(F.AnalyticEvents.ACTIVITY_IFRAME_UNMOUNT, {
+             channel_id: u.id,
+             guild_id: u.getGuildId(),
+             application_id: l,
+             instance_ids: [a.instanceId],
+             media_session_ids: a.mediaSessionIds,
+             activity_user_session_id: a.activityUserSessionId,
+             raw_thermal_state: T,
+             duration_ms: r,
+           }),
+           delete G[l],
+           delete w[l];
        }
```

```diff
          var t, i;
          let {
              channelId: n,
              embeddedActivity: l,
- 
- 
+       function J(e) {
+             connections: a,
              updateCode: r,
            } = e,
```

```diff
          if (
-           o = N.default.getEmbeddedActivitiesForChannel(n),
-           s = _.default.getChannel(n);
- 
-             null !== (i = null == s ? void 0 : s.isPrivate()) &&
- 
+           s = I.default.getId(),
+           (r === R.EmbeddedActivityUpdateCodes.ACTIVITY_STARTED &&
              void 0 !== i &&
              i &&
              o.length <= 1 &&
```

```diff
          )
            return;
-             a.default.selectParticipant(n, null),
-           !u.some(e => e.user_id === d))
- 
-           { application_id: I } = l,
-           A = (0, O.default)(l),
-           T = null == c && (null == s ? void 0 : s.isVocal()) === !0;
-         null != I &&
-           null != A &&
-           !T &&
-           (null === (t = F[I]) ||
- 
+             void 0 === a.find(e => e.user_id === s) &&
+         let f = T.default.getMediaSessionId(),
              void 0 === t ||
```

```diff
              }),
-               mediaSessionId: null != c ? c : null,
-               activitySessionId: A,
- 
- 
+             t.call(G, {
+           delete G[_]);
        }
```

```diff
            }
          }
        }
-         let { mediaSessionId: t } = e,
-           i = E.default.getChannelId();
-         if (null != t && null != i) {
-           let e = N.default.getSelfEmbeddedActivityForChannel(i),
-             l = null == e ? void 0 : e.applicationId,
-             a = (0, O.default)(e);
-           if (null != l && null != t && null != a) {
-             var n;
-             null === (n = F[l]) ||
-               void 0 === n ||
-               n.call(F, { mediaSessionId: t, activitySessionId: a }),
-               delete F[l];
- 
- 
+       function x(e) {
+       n = class extends s.default {
          _initialize() {
```

```diff
                "EMBEDDED_ACTIVITY_LAUNCH_FAIL",
                this.handleActivityLaunchFail
              ),
-             l.default.subscribe(
- 
-             l.default.subscribe("EMBEDDED_ACTIVITY_CLOSE", G),
-             l.default.subscribe("EMBEDDED_ACTIVITY_INBOUND_UPDATE", B),
-             l.default.subscribe(
- 
+           C.default.addChangeListener(this.handleSelectedChannelUpdate),
+             r.default.subscribe("EMBEDDED_ACTIVITY_OPEN", H),
                "EMBEDDED_ACTIVITY_DEFERRED_OPEN",
                this.handleDeferredOpen
              ),
```

```diff
                "RPC_APP_DISCONNECTED",
                this.handleRPCDisconnect
              ),
- 
- 
+             r.default.subscribe(
+             r.default.subscribe("MEDIA_SESSION_JOINED", x);
          }
          _terminate() {
```

```diff
                "EMBEDDED_ACTIVITY_LAUNCH_FAIL",
                this.handleActivityLaunchFail
              ),
-             l.default.unsubscribe(
- 
-             l.default.unsubscribe("EMBEDDED_ACTIVITY_CLOSE", G),
-             l.default.unsubscribe("EMBEDDED_ACTIVITY_INBOUND_UPDATE", B),
-             l.default.unsubscribe(
- 
+           C.default.removeChangeListener(this.handleSelectedChannelUpdate),
+             r.default.unsubscribe("EMBEDDED_ACTIVITY_OPEN", H),
                "EMBEDDED_ACTIVITY_DEFERRED_OPEN",
                this.handleDeferredOpen
              ),
```

```diff
                "RPC_APP_DISCONNECTED",
                this.handleRPCDisconnect
              ),
- 
- 
+             r.default.unsubscribe(
+             r.default.unsubscribe("MEDIA_SESSION_JOINED", x);
          }
          constructor(...e) {
            super(...e),
              (this.handleSelectedChannelUpdate = () => {
```

```diff
                  .getSelfEmbeddedActivities()
                  .values())
-               for (let { channelId: t, applicationId: i } of N.default
- 
- 
+               let e = C.default.getVoiceChannelId();
+                 (0, V.default)(t) &&
                    t !== e &&
                    this.leaveActivity({ channelId: t, applicationId: i });
                if (null != e) {
```

```diff
                  t.forEach(e => {
                    if (e.userIds.has(i)) {
-                   i = f.default.getId();
- 
- 
+                 let t = p.default.getEmbeddedActivitiesForChannel(e),
+                     let t = p.default.getSelfEmbeddedActivityForChannel(
                        e.channelId
                      );
                      null == t &&
```

```diff
              }),
              (this.handleActivityLaunchFail = e => {
                let { error: t, guildId: i } = e;
                if (null == i) return;
                let n =
- 
- 
+                       (0, h.disconnectEmbeddedActivity)(
+                 Y.default.Messages.EMBEDDED_ACTIVITIES_LAUNCH_FAIL_GENERIC;
                switch (t.code) {
```

```diff
                    break;
-                   n = V.default.Messages.EMBEDDED_ACTIVITIES_LAUNCH_FAIL_ACCESS;
- 
- 
+                 case F.AbortCodes.INVALID_ACTIVITY_LAUNCH_NO_ACCESS:
+                 case F.AbortCodes.INVALID_ACTIVITY_LAUNCH_PREMIUM_TIER:
                    n =
```

```diff
                    break;
- 
- 
+                     Y.default.Messages.EMBEDDED_ACTIVITIES_LAUNCH_FAIL_PREMIUM;
+                 case F.AbortCodes.INVALID_ACTIVITY_LAUNCH_CONCURRENT_ACTIVITIES:
                    n =
```

```diff
                        .EMBEDDED_ACTIVITIES_LAUNCH_FAIL_CONCURRENT;
                    break;
- 
- 
+                     Y.default.Messages
+                 case F.AbortCodes.INVALID_PERMISSIONS:
                    n =
```

```diff
                    break;
- 
-                   n = V.default.Messages.EMBEDDED_ACTIVITIES_INVALID_CHANNEL;
- 
+                     Y.default.Messages.EMBEDDED_ACTIVITIES_INVALID_PERMISSIONS;
+                 case F.AbortCodes.INVALID_ACTIVITY_LAUNCH_AFK_CHANNEL:
                    break;
```

```diff
                    n =
- 
- 
+                 case F.AbortCodes.INVALID_ACTIVITY_LAUNCH_AGE_GATED:
+                     Y.default.Messages.EMBEDDED_ACTIVITIES_LAUNCH_FAIL_AGE_GATE;
                    break;
```

```diff
                    .INVALID_ACTIVITY_LAUNCH_DEV_PREVIEW_GUILD_SIZE:
                    n =
- 
- 
+                 case F.AbortCodes
+                     Y.default.Messages
                        .EMBEDDED_ACTIVITIES_LAUNCH_FAIL_GUILD_SIZE;
                }
                this.showLaunchErrorModal(n);
              }),
              (this.superHandleRPCDisconnect = e => {
```

```diff
                    .getSelfEmbeddedActivities()
                    .values())
                    e === n &&
                      this.leaveActivity({ channelId: t, applicationId: n });
- 
- 
+                 for (let { applicationId: e, channelId: t } of p.default
+                 t.code !== F.RPCCloseCodes.CLOSE_NORMAL &&
                    this.showErrorModal(t, n);
                }
              }),
              (this.handleDeferredOpen = async e => {
                var t, i, n;
```

```diff
                if (
-                 s = _.default.getChannel(a);
- 
-                 (c.GUILD_VOCAL_CHANNEL_TYPES.has(null == s ? void 0 : s.type) &&
-                   I.default.getVoiceChannelId() !== a)
- 
+               let { channelId: a, applicationId: u, analyticsLocations: r } = e,
+                 void 0 === d ||
                )
                  return;
```

```diff
                  this.showLaunchErrorModal(
-               if ((null == f ? void 0 : f.applicationId) === u) return;
-               let E = await r.default.fetchApplication(u),
-                 A = (0, y.getIsActivitiesEnabledForCurrentPlatform)();
-               if (!A) {
- 
- 
+               let s = p.default.getSelfEmbeddedActivityForChannel(a);
+                   Y.default.Messages.EMBEDDED_ACTIVITIES_NOT_AVAILABLE_ON_OS
                  );
                  return;
                }
                if (
```

```diff
                      ? void 0
-                   null == E
- 
- 
+                 !(0, U.default)(
+                     : null === (t = f.embedded_activity_config) || void 0 === t
                        ? void 0
                        : t.supported_platforms
                  )
                ) {
                  this.showLaunchErrorModal(
```

```diff
                      .EMBEDDED_ACTIVITIES_APPLICATION_UNSUPPORTED_OS
                  );
                  return;
                }
- 
-               null != T &&
-                 (await r.default.fetchApplication(T),
-                 (l = d.default.getApplication(T)));
-               let C =
-                   null !== (i = null == s ? void 0 : s.getGuildId()) &&
- 
+                   Y.default.Messages
+               let I = null == s ? void 0 : s.applicationId;
                    void 0 !== i
                      ? i
                      : void 0,
```

```diff
                    applicationId: u,
                    activityConfigs: v,
-                 S.fetchShelf)({ guildId: C }),
-                 g = (0, h.default)({
- 
- 
+                 { activityConfigs: v, applications: S } = await (0,
+                   applications: S,
                  });
```

```diff
                    applicationId: u,
                    activityConfigs: e.activityConfigs,
                    applications: e.applications,
                  });
                }
-                 let e = await (0, S.fetchShelf)({ guildId: C, force: !0 });
-                 g = (0, h.default)({
- 
- 
+               if (null == N) {
+               let y = p.default
                    .getEmbeddedActivitiesForChannel(a)
                    .find(e => e.applicationId === u),
                  m =
```

```diff
                    void 0 !== n
                      ? n
                      : 0;
                m > 0
- 
- 
+                   null !== (n = null == y ? void 0 : y.userIds.size) &&
+                 ? (0, O.maybeJoinEmbeddedActivity)({
                      channelId: a,
                      applicationId: u,
```

```diff
                      inputApplication: null,
- 
- 
+                     instanceId: null == y ? void 0 : y.instanceId,
+                     analyticsLocations: r,
                      embeddedActivitiesManager: this,
                    })
```

```diff
                      currentActivity: l,
                      channelId: a,
-                     activityItem: g,
- 
- 
+                 : await (0, g.default)({
+                     guildId: T,
                      embeddedActivitiesManager: this,
```

```diff
        var l = i("77078"),
          a = i("870346"),
          u = i("49111");
        function r(e) {
          let { application: t, onAgree: r, onDisagree: d } = e,
- 
-           s = o ? l.POPOUT_MODAL_CONTEXT : l.DEFAULT_MODAL_CONTEXT;
- 
+                     analyticsLocations: r,
+           s = a.default.getWindowOpen(u.PopoutWindowKeys.CHANNEL_CALL_POPOUT),
          return (
            (0, l.openModalLazy)(
              async () => {
                let { ActivityAgeGateModal: e } = await i
                  .el("413012")
```

```diff
          l = i("299285"),
          a = i("653047"),
          u = i("42203"),
          r = i("18494"),
          d = i("697218"),
- 
-         s = i("550766"),
- 
+             { modalKey: "activity-age-gate", contextKey: o }
+         s = i("427953"),
          c = i("544805"),
          f = i("370507"),
          _ = i("420444"),
          E = i("541473"),
          I = i("407908"),
```

```diff
            !v
          )
            return !1;
          return (
            (0, A.default)(r, t),
- 
- 
+           !(0, s.isActivitiesInTextEnabled)(a, "joinEmbeddedActivity") ||
+           (0, o.startEmbeddedActivity)(t, e, n),
            (0, I.default)({
              type: C.AnalyticsGameOpenTypes.JOIN,
              userId: c.id,
              applicationId: e,
              locationObject: i,
```

```diff
              embeddedActivitiesManager: _,
              analyticsLocations: E,
            } = e,
-             locationObject: s,
- 
- 
+             activityChannelId: s,
+           I = u.default.getChannel(s),
            T = null == I ? void 0 : I.getGuildId(),
            C = null == T || "" === T,
            S = d.default.getCurrentUser();
```

```diff
            return Promise.resolve(!1);
          if (
- 
- 
+         if (null == I || (C && !I.isPrivate()) || null == s)
+           r.default.getVoiceChannelId() === s &&
            (null == i ? void 0 : i.id) === t
          )
```

```diff
              )
                return new Promise(n => {
                  (0, c.confirmActivityAgeGate)({
                    application: i,
                    onAgree: () => {
- 
- 
+           return (0, A.default)(T, s), Promise.resolve(!0);
+                     n(v(t, s, o, E, e));
                    },
                    onDisagree: () => n(!1),
                  });
                });
            }
```

```diff
            ? new Promise((e, t) => {
                (0, f.default)(
                  i,
                  I,
                  () => {
- 
- 
+           return v(t, s, o, E, e);
+                   _.leaveActivity({ channelId: s, applicationId: i.id }),
                      N({ bypassChangeVcModal: !0 }).then(e).catch(t);
                  },
                  () => e(!0)
                );
              })
```

```diff
              instanceId: C,
              inputApplication: v,
              analyticsLocations: S,
              embeddedActivitiesManager: N,
            } = e,
-         s = i("957255"),
- 
-           D = h.find(
- 
+         s = i("305961"),
+           y = _.default.getEmbeddedActivitiesForChannel(i),
              e => e.applicationId === T && (null == C || e.instanceId === C)
            ),
            p = v;
          if (null == p) {
            let e = await l.default.fetchApplication(T);
```

```diff
            O = (0, I.default)({
-         let y = c.default.getCurrentUser(),
- 
- 
+         if (null == h || null == p) return;
+             userId: null == D ? void 0 : D.id,
              application: p,
              channelId: i,
```

```diff
              isActivitiesEnabledForCurrentPlatform: !0,
              ChannelStore: d.default,
              VoiceStateStore: f.default,
- 
-             GuildStore: o.default,
- 
+             currentUser: D,
+             PermissionStore: o.default,
            }),
            g = _.default.getSelfEmbeddedActivityForChannel(i),
            L = null == g ? void 0 : g.applicationId,
            m =
              null != L &&
```

```diff
                (await (0, E.default)({
- 
- 
+             null != h &&
+                 applicationId: h.applicationId,
                  currentEmbeddedApplication: m,
                  activityChannelId: i,
                  locationObject: {},
                  embeddedActivitiesManager: N,
                  analyticsLocations: S,
```

```diff
          l = i("42203"),
          a = i("305961"),
          u = i("957255"),
          r = i("697218"),
          d = i("659500"),
- 
-         s = i("898065"),
- 
+             return h;
+         s = i("427953"),
          c = i("550766"),
          f = i("191225"),
          _ = i("544805"),
          E = i("370507"),
          I = i("943349"),
```

```diff
          let {
              activityItem: t,
              currentActivity: i,
-       function D(e) {
- 
-             channelId: s,
- 
+         y = i("49111");
+             locationObject: s,
              guildId: c,
              embeddedActivitiesManager: A,
              analyticsLocations: T,
            } = e,
            C = a.default.getGuild(c),
```

```diff
          if (
- 
- 
+           h = l.default.getChannel(N);
+           (null == C && !(0, S.isPrivateChannelWithEnabledActivities)(o)) ||
            null == v ||
            null == t
          )
            return Promise.resolve(!1);
```

```diff
            return (
              d.ComponentDispatch.dispatch(
-         if (null == y) return Promise.resolve(!1);
-         if (null == s)
- 
-               { applicationId: y.id }
- 
+         let { application: D, activity: O } = t;
+               y.ComponentActions.SHOW_ACTIVITIES_CHANNEL_SELECTOR,
              ),
              Promise.resolve(!1)
            );
          let g =
```

```diff
              ? (0, I.getEmbeddedActivityLaunchability)({
- 
- 
+           null != o
+                 channelId: o,
                  ChannelStore: l.default,
                  GuildStore: a.default,
                  PermissionStore: u.default,
                })
              : I.EmbeddedActivityLaunchability.NO_CHANNEL;
```

```diff
                    onAgree: () =>
                      t(
                        p({
- 
- 
+                   application: D,
+                         channelId: o,
                          guildId: null == C ? void 0 : C.id,
```

```diff
                      ),
                    onDisagree: () => t(!1),
                  });
                })
              : p({
-                         application: y,
- 
- 
+                         locationObject: s,
+                 channelId: o,
                  guildId: null == C ? void 0 : C.id,
```

```diff
          };
          return null != i
            ? new Promise(e => {
                (0, E.default)(
                  i,
-                 application: y,
- 
-                 D,
- 
+                 locationObject: s,
+                 h,
                  () => {
```

```diff
            I = N.SUPPORTED_ACTIVITY_IN_TEXT_CHANNEL_TYPES.includes(_.type);
          if (E) {
            let e = await (0, T.default)({ channelId: t, bypassChangeModal: d });
            if (!e) return !1;
          } else if (
- 
- 
+                   A.leaveActivity({ channelId: o, applicationId: i.id }),
+           !(0, s.isActivitiesInTextEnabled)(_, "handleStartEmbeddedActivity") ||
            !I
          )
            return !1;
          return (
            c.startEmbeddedActivity(t, a.id, u),
```

```diff
              userId: f.id,
              applicationId: a.id,
              locationObject: n,
              analyticsLocations: u,
            }),
- 
- 
+             type: y.AnalyticsGameOpenTypes.LAUNCH,
+           o.markActivityUsed(a.id),
            !0
          );
        }
      },
      126939: function (e, t, i) {
```

```diff
          if (c)
            return (
              (0, a.default)({
                userId: t.id,
                activity: i,
-             currentUser: s,
- 
-               currentUser: s,
- 
+             channelId: s,
+               channelId: s,
                application: d,
                isActivitiesEnabledForCurrentPlatform: v,
                ChannelStore: f,
                VoiceStateStore: T,
                PermissionStore: C,
```

```diff
            userId: l,
            activity: a,
            application: u,
            channelId: r,
            currentUser: d,
-         s = i("800762"),
- 
-           ChannelStore: s,
- 
+         s = i("697218"),
+           isActivitiesEnabledForCurrentPlatform: s,
            VoiceStateStore: f,
            PermissionStore: I,
            GuildStore: A,
          } = e;
          if (null == l) return 8;
```

```diff
                      null == a ? void 0 : a.session_id
                    )) || void 0 === n
                ? void 0
                : n.channelId;
          if (null == T) return 4;
- 
- 
+         if (!s) return 5;
+         let C = o.getChannel(r);
          if (null == C) return 4;
          let v = C.getGuildId();
          if (!C.isPrivate()) {
            if (null == v) return 10;
            let e = A.getGuild(v);
```

```diff
            ),
            E = (0, a.useStateFromStores)(
-             o.default.getCurrentUser()
- 
- 
+           _ = (0, a.useStateFromStores)([s.default], () =>
+             [u.default, o.default, d.default, r.default],
              () =>
                I({
                  userId: t,
                  activity: i,
                  application: l,
```

```diff
          l,
          a = i("446674"),
          u = i("42203"),
          r = i("305961"),
          d = i("957255"),
- 
-         s = i("49111"),
- 
+                 VoiceStateStore: o.default,
+         s = i("702173"),
          c = i("782340");
        function f(e) {
          let {
              channelId: t,
              ChannelStore: i,
```

```diff
            let e = a.getGuildId();
            if (null == e) return 4;
            let t = n.getGuild(e);
            if ((null == t ? void 0 : t.afkChannelId) === a.id) return 5;
- 
- 
+         if (!(0, s.isPrivateChannelWithEnabledActivities)(a.id)) {
+           let i = l.can(o.Permissions.CONNECT, a);
            if (!i) return 2;
```

```diff
          l = i("242740"),
          a = i("848848"),
          u = i("42203"),
          r = i("957255"),
          d = i("18494"),
- 
-       class s extends Error {}
- 
+           let u = l.can(o.Permissions.USE_EMBEDDED_ACTIVITIES, a);
+         s = i("800762");
        async function c(e) {
          let { channelId: t, timeoutMs: i = 1e4, bypassChangeModal: c = !1 } = e,
            f = u.default.getChannel(t);
          if (null == f) return !1;
          let _ = await l.default.handleVoiceConnect({
```

```diff
            ).needSubscriptionToAccess,
          });
          if (!_) return !1;
          let E = new Promise((e, n) => {
            let l = setTimeout(() => {
- 
- 
+           connected: s.default.isInChannel(t),
+             n(new o("Joining voice channel has timed out."));
            }, i);
            d.default.addConditionalChangeListener(() => {
              let i = d.default.getVoiceChannelId();
              return i !== t || (clearTimeout(l), e(), !1);
            });
```

```diff
            source: i,
            userId: a,
            applicationId: u,
            partyId: r,
            messageId: d,
- 
-           analyticsLocations: s,
- 
+           if (e instanceof o) return !1;
+           locationObject: s,
          } = e;
          n.default.track(l.AnalyticEvents.APPLICATION_OPENED, {
            type: t,
            source: i,
            application_id: u,
```

```diff
        var l = i("77078"),
          a = i("913144"),
          u = i("135230"),
          r = i("550766"),
          d = i("648456"),
-           location_stack: s,
- 
-       class s extends d.default {
- 
+           location: s,
+         s = i("782340");
          showErrorModal(e) {
            let { code: t, message: i } = e;
            (0, l.openModalLazy)(
              async () => e =>
                (0, n.jsx)(u.default, {
```

```diff
          }
          showLaunchErrorModal(e) {
            (0, l.openModalLazy)(
              async () => t =>
                (0, n.jsx)(u.default, {
- 
- 
+                   s.default.Messages.EMBEDDED_ACTIVITIES_ERROR_TITLE.format({
+                 title: s.default.Messages.EMBEDDED_ACTIVITIES_LAUNCH_FAILURE,
                  body: e,
                  ...t,
                })
            );
          }
```

```diff
          i.d(t, {
            default: function () {
              return d;
            },
            useGetOrFetchApplication: function () {
- 
- 
+       var c = new o();
+             return s;
            },
          });
        var n = i("884691"),
          l = i("446674"),
          a = i("233736"),
```

```diff
        var l = i("77078"),
          a = i("987317"),
          u = i("76393"),
          r = i("393414"),
          d = i("755624"),
- 
-         s = i("271938"),
- 
+       function s(e) {
+         s = i("263024"),
          c = i("18494"),
          f = i("800762"),
          _ = i("792367"),
          E = i("49111"),
          I = {
```

```diff
                !d.default.hasJoined(t.id) &&
- 
- 
+               (await s.default.unarchiveThreadIfNecessary(t.id),
+                 (await s.default.joinThread(t, "Join Voice")));
              let N = u.default.getRemoteSessionId(),
```

```diff
                p =
-               D = (null == h ? void 0 : h.channelId) === t.id,
- 
-                 D ||
- 
+               y = f.default.getVoiceStateForSession(o.default.getId(), N),
+                 h ||
                  c.default.getChannelId() ===
                    f.default.getCurrentClientVoiceChannelId(t.guild_id);
              return !v &&
                !T &&
                (0, _.shouldShowVoiceChannelChangeConfirmation)(t)
```

```diff
          if (!r.default.isProtocolRegistered())
            return Promise.reject(Error("protocol is not registered"));
          let t = d.default.getPlayableComputerDevices();
          if (
            l.default.isObservedAppRunning(
-         s = i("49111");
- 
- 
+         s = i("450484"),
+             n.default.get(o.PlatformTypes.SPOTIFY).name
            ) &&
            t.length > 0
          ) {
            let { socket: e, device: i } = t[0];
            return (
```

```diff
          });
        var n = i("884385");
        function l(e, t, i, l) {
          var a, u, r;
          let d = e.hasConnectedAccount(),
- 
-           s = e.getTrack(),
- 
+             window.open("".concat(s.SPOTIFY_APP_PROTOCOL, ":"));
+           s = (0, n.isSpotifyPlayable)(e),
            c = e.getSyncingWith(),
            f = e.getActivity(),
            _ =
              null !==
                (r =
```

```diff
                : e.getLastPlayedTrackId();
          return {
            user: i,
            activity: l,
            hasSpotifyAccount: d,
- 
-           notPlayable: d && !o,
- 
+                 null !== (u = null == o ? void 0 : o.id) && void 0 !== u
+           canPlaySpotify: s,
            syncingWithParty:
              (null == f ? void 0 : f.party) != null &&
              (null == l
                ? void 0
                : null === (a = l.party) || void 0 === a
```

```diff
        var l = i("77078"),
          a = i("968194"),
          u = i("884385"),
          r = i("170108"),
          d = i("922174");
- 
-         let { hasSpotifyAccount: s, activity: c, user: f } = e;
-         (0, d.default)(s) &&
- 
+             return s;
+       async function s(e, t, s) {
            null != c &&
            null != c.sync_id &&
            (await (0, u.ensureSpotifyPlayable)(),
            await (0, u.ensureSpotifyPremium)().catch(
              e => (
```

```diff
        var n = i("968194"),
          l = i("884385"),
          a = i("170108"),
          u = i("922174");
        async function r(e, t, i) {
- 
- 
+           (0, r.default)(t, f, c, s));
+         let { hasSpotifyAccount: r, activity: d, user: s } = e;
          (0, u.default)(r) &&
            null != d &&
            null != d.sync_id &&
            (await (0, l.ensureSpotifyPlayable)(),
```

```diff
      349649: function (e, t, i) {
        "use strict";
        i.r(t),
          i.d(t, {
            default: function () {
-           (0, a.default)(t, o, d, i));
- 
- 
+           n.play(d, s.id),
+             return s;
            },
          });
        var n = i("884691"),
          l = i("446674"),
          a = i("872717"),
```

```diff
          let t = (0, l.useStateFromStores)([r.default], () =>
            r.default.getNote(e)
          );
          return (
            n.useEffect(() => {
- 
- 
+       function s(e) {
+             null == t && o(e);
            }, [t, e]),
            null != t ? t : { loading: !0, note: null }
          );
        }
```

```diff
          i.d(t, {
            openUserProfileModal: function () {
              return d;
            },
            closeUserProfileModal: function () {
- 
- 
+       async function o(e) {
+             return s;
            },
          });
        var n = i("913144"),
          l = i("327037"),
          a = i("697218"),
```

```diff
              analyticsLocation: f,
            } = e,
            _ = a.default.getUser(t),
            E = d !== r.ME ? d : void 0;
          if (null == _)
-             friendToken: s,
- 
- 
+             channelId: s,
+           return (0, l.fetchProfile)(t, { friendToken: o, guildId: E }).then(
              () => {
                n.default.dispatch({
                  type: "USER_PROFILE_MODAL_OPEN",
                  userId: t,
                  section: i,
```

```diff
                });
              }
            );
          (0, u.default)(t, _.getAvatarURL(void 0, 80), {
            withMutualGuilds: !0,
-                 friendToken: s,
- 
- 
+                 channelId: s,
+           friendToken: o,
            guildId: E,
          }),
            n.default.dispatch({
              type: "USER_PROFILE_MODAL_OPEN",
              userId: t,
```

```diff
              autoFocusNote: c,
              analyticsLocation: f,
            });
        }
-             friendToken: s,
- 
- 
+             channelId: s,
+       function s() {
          n.default.dispatch({ type: "USER_PROFILE_MODAL_CLOSE" });
        }
      },
      645999: function (e, t, i) {
        "use strict";
```

```diff
          var n;
- 
-           s = null !== (n = r[o]) && void 0 !== n ? n : {};
- 
+       function s(e, t, i) {
+         let { applicationId: s } = i,
          if (
```

```diff
            !__OVERLAY__ && e === u.ActivityActionStates.FAILED)
          ) {
-           (r[o] = s),
- 
- 
+           ((o[t] = e),
+           null != d[s] && d[s].stop();
            let e = new l.Timeout();
            e.start(12e4, () =>
              a.default.dispatch({
                type: "ACTIVITY_LAUNCH_FAIL",
```

```diff
                activityType: t,
              })
            ),
- 
- 
+               applicationId: s,
+             (d[s] = e);
          }
        }
```

```diff
          OVERLAY_INITIALIZE: function (e) {
            let { activityLauncherStates: t } = e;
            r = { ...t };
          },
          ACTIVITY_JOIN_LOADING: e =>
-         return o(
- 
- 
+       function o(e) {
+           s(u.ActivityActionStates.LOADING, u.ActivityActionTypes.JOIN, e),
          ACTIVITY_JOIN_FAILED: e =>
```

```diff
          },
        });
      },
    },
  ]);
-         ACTIVITY_JOIN: s,
-         EMBEDDED_ACTIVITY_CLOSE: s,
- 
- 
+           s(u.ActivityActionStates.FAILED, u.ActivityActionTypes.JOIN, e),
+ //# sourceMappingURL=47146.14b04fbabb2e15d96fb8.js.map

```